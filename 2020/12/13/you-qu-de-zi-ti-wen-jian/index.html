<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><link rel="icon" sizes="any" type="image/svg+xml" href="/imgs/icon.svg"><link rel="stylesheet" href="/css/theme/color.variables.css"><link id="themeStyleVar" rel="stylesheet" href="/css/theme/default.variables.css"><script>const localStorageTheme = localStorage.getItem('theme');
        function loadTheme(){
            let themeLink = document.getElementById('themeStyleVar');
            if(localStorageTheme){
                themeLink.href = themeLink.href.replace(/\/css\/theme.*/,`/css/theme/${localStorageTheme}.variables.css`)
            }
        }
        if(localStorage){
            loadTheme()
            setTimeout(()=>{
                if(document.body){
                    document.body.className = localStorageTheme ? localStorageTheme : 'dark'
                }

            },2)
        }</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="/css/post.css"><title>苏鑫2017</title><meta name="description" content="用于记录感悟，前端技术，编程技巧，各种奇奇怪怪的新的体会"><meta name="viewport" content="width=device-width,initial-scale=1"><script async>console.log(`%c真巧，你打开了devtool`,"color:#b58900")
        console.log(`%c真巧，你看了我的文章`,"color:#859900")
        console.log('%c简单介绍，道法自然，做人要顺其自然，不要有太多欲望',"color:#268bd2")
        console.log('%c不要目的性太强,这就是我的主题想强调的',"color:#dc322f")</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-RFGTVED02M"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-RFGTVED02M")</script><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?ce46d6101f33ba04b74fbe8bbe509590";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script>const moduleMap = new Map();
            var define = (moduleName, module) => { moduleMap.set(moduleName, module) };
            var require = (moduleName) => moduleMap.get(moduleName);</script><meta name="generator" content="Hexo 5.4.2"><link rel="alternate" href="/atom.xml" title="苏鑫2017" type="application/atom+xml"></head><body><div class="body"><header class="header"><div class="header-icon-wrapper"><h2><a href="/">苏鑫2017</a></h2></div><div class="header-right"><nav class="header-menu-wrapper"><ul class="header-menu"><li class="header-menu-item"><a class="header-menu-item-link" href="/">首页</a></li><li class="header-menu-item"><a class="header-menu-item-link" href="/categories/weibo">微博</a></li><li class="header-menu-item"><a class="header-menu-item-link" href="/about">关于</a></li><li class="header-menu-item"><div id="switchThemeButton"><img src="/imgs/icon.svg" alt="switchThemeIcon" width="100%" height="100%"></div><style>#switchThemeButton{width:40px;height:26px;margin:0;border:0;background:0 0;outline:0;cursor:pointer;margin-top:6px}</style><script async>const btn = document.getElementById('switchThemeButton');
    let darkTheme = false;
    const themeStyleVarId = "themeStyleVar";
    if(localStorageTheme === 'dark'){
        darkTheme = true
    }else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
        // dark mode
        darkTheme = true;
    }
    function loadTheme() {
        let themeLink = document.getElementById(themeStyleVarId);
        if (!themeLink) {
            themeLink = document.createElement('link')
            themeLink.rel = "stylesheet"
            themeLink.id = "themeStyleVar"
        }
        darkTheme = !darkTheme;
        themeLink.href = themeLink.href.replace(/\/css\/theme.*/,`/css/theme/${darkTheme ? 'dark' : 'light'}.variables.css`)
        document.head.appendChild(themeLink)
        document.body.className = darkTheme?'dark':'light'
        localStorage.setItem('theme',darkTheme?'dark':'light');
    }

    btn.onclick = function() {
        loadTheme();
        codeTheme();
    }</script><script>function codeTheme(){
            const localStorageTheme = localStorage.getItem('theme');
            let codeThemeLink = document.getElementById("codeTheme");
            if(!codeThemeLink){
                codeThemeLink = document.createElement('link');
                codeThemeLink.rel = "stylesheet"
                codeThemeLink.id = "codeTheme"
                document.head.appendChild(codeThemeLink)
            }
            if(localStorageTheme){
                codeThemeLink.href = `//cdn.jsdelivr.net/npm/highlightjs@9.16.2/styles/solarized-${localStorageTheme}.css`
            }else{
                codeThemeLink.href = `//cdn.jsdelivr.net/npm/highlightjs@9.16.2/styles/solarized-${darkTheme ? 'dark': 'light'}.css`
            }
        }
        codeTheme()</script></li></ul></nav></div></header><main class="main"><div class="post"><h2>有趣的字体文件</h2><h2 id="字体历史">字体历史</h2><p>话说在计算机市场刚刚开辟的时候，字体市场 Adobe 一家独大，通过贩卖格式认证赚了很多钱，但是苹果想白嫖 Adobe 自然不干。</p><p>于是苹果公司另起炉灶搞起了自己的 TrueType，但是当时已经有了一大批 Adobe 付费用户，自然没必要支持苹果。</p><p>然后苹果拉起了同盟，微软，两人情投意合，眉来眼去一起搞起了字体协议。</p><p>两人联手把 Adobe 搞的不行，目前市场上最常见的就是 TrueType 的字体格式了。这场没有硝烟的战争最后赢在了想白嫖但是没成功的人身上。</p><p>两家分别在自己的字体文档外链对方的文档地址，惺惺相惜。</p><h2 id="TrueType-的字体文件存储格式">TrueType 的字体文件存储格式</h2><p>如果刚看字体文件的官方文档对于很少基础二进制的人来说会有那么一点点陌生。</p><p>首先字体文件是用表进行字体文件描述的。</p><p>按照文档字段约束读取描述文件信息。</p><p>首先我们需要用到的 api 是 DataView，DataView 是一个可以方便读取二进制的对象。</p><p>详情可查看<a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/DataView">MDN DataVuew</a>,浏览器兼容性很好。</p><p>比如对于下面一段字体信息我们应该怎么做</p><pre><code class="hljs">  <span class="hljs-title class_">Offset</span>: <span class="hljs-number">00</span> <span class="hljs-number">01</span> <span class="hljs-number">02</span> <span class="hljs-number">03</span> <span class="hljs-number">04</span> <span class="hljs-number">05</span> <span class="hljs-number">06</span> <span class="hljs-number">07</span> <span class="hljs-number">08</span> <span class="hljs-number">09</span> 0A 0B 0C 0D 0E 0F
<span class="hljs-number">00000000</span>: <span class="hljs-number">00</span> <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> 0E <span class="hljs-number">00</span> <span class="hljs-number">80</span> <span class="hljs-number">00</span> <span class="hljs-number">03</span> <span class="hljs-number">00</span> <span class="hljs-number">60</span> 4F <span class="hljs-number">53</span> 2F <span class="hljs-number">32</span>    ...........<span class="hljs-string">`OS/2
</span></code></pre><p>对于单个字体的文件</p><p>按照文档约定从文件第 0 位开始的</p><table><thead><tr><th>Type</th><th>Name</th><th>Description</th></tr></thead><tbody><tr><td>uint32</td><td>sfntVersion</td><td>0x00010000 or 0x4F54544F (‘OTTO’) — see below.</td></tr><tr><td>uint16</td><td>numTables</td><td>Number of tables.</td></tr><tr><td>uint16</td><td>searchRange</td><td>Maximum power of 2 less than or equal to numTables, times 16 ((2<strong>floor(log2(numTables))) * 16, where “</strong>” is an exponentiation operator).</td></tr><tr><td>uint16</td><td>entrySelector</td><td>Log2 of the maximum power of 2 less than or equal to numTables (log2(searchRange/16), which is equal to floor(log2(numTables))).</td></tr><tr><td>uint16</td><td>rangeShift</td><td>numTables times 16, minus searchRange ((numTables * 16) - searchRange).</td></tr></tbody></table><p>所以我们的版本信息读取代码就是</p><pre><code class="hljs"><span class="hljs-comment">// 4 sfntVersuin 2 numTables 2 searchRange 2 entrySelector 2 rangeShift</span>
<span class="hljs-keyword">const</span> tableDirectory = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DataView</span>(ttfArrayBuffer, <span class="hljs-number">0</span>, <span class="hljs-number">4</span> + <span class="hljs-number">2</span> + <span class="hljs-number">2</span> + <span class="hljs-number">2</span> + <span class="hljs-number">2</span>);
<span class="hljs-keyword">let</span> offset = <span class="hljs-number">0</span>;
<span class="hljs-keyword">let</span> sfntVersion = view1.<span class="hljs-title function_">getUint32</span>(offset);
offset += <span class="hljs-number">4</span>;
<span class="hljs-keyword">let</span> numTables = view1.<span class="hljs-title function_">getUint16</span>(offset);
offset += <span class="hljs-number">2</span>;
<span class="hljs-keyword">let</span> searchRange = view1.<span class="hljs-title function_">getUint16</span>(offset);
offset += <span class="hljs-number">2</span>;
<span class="hljs-keyword">let</span> entrySelector = view1.<span class="hljs-title function_">getUint16</span>(offset);
offset += <span class="hljs-number">2</span>;
<span class="hljs-keyword">let</span> rangeShift = view1.<span class="hljs-title function_">getUint16</span>(offset);
</code></pre><p>这样我们就可以读取字体信息了。</p><h2 id="字形的查找">字形的查找</h2><p><img src="/imgs/funnyfont.png" alt="字体的查找"></p><p>对于一个 unicode 我们如何找到它对应的字体形状呢。</p><p>首先字体是以表存储的，每个表都代表不同的信息。</p><p>字体到字形映射是通过 cmap 进行映射的。所以我们需要在 cmap 查找到当前平台对应的子表</p><p>然后通过 cmap 子表不同的 format 规则 gid 字形 id</p><p>获取的 SVG 或者 CFF 或者 glyf 表的位置</p><p>然后就是字体渲染了。</p><p>具体处理逻辑很绕，有兴趣的可以看看一个简单的 font 处理库的源码<a target="_blank" rel="noopener" href="https://github.com/photopea/Typr.js/blob/gh-pages/src/Typr.U.js#L61">Typr.U.js#L61</a></p><h2 id="字体文件应用">字体文件应用</h2><h3 id="字体优化">字体优化</h3><p>无论是移动端用户还是 PC 端用户，如果上了字体必然要做字体优化。</p><p>面对一个几 M 大小的字体文件，对于用户可能页面信息看完了，也没记载出来，所以很少有人用网络加载自定义字体。</p><p>不过如果场景固定（文案不会变）我们就能对其进行字体抽离，然后生成新的字体文件，只包含我们需要的，字体文件的大小将大大减少。</p><p>一方面可以将压缩文件上传<code>cdn</code></p><p>另一方面我们可以直接转化成 base64 通过<code>@font-face&#123;url(base64)&#125;</code>去加载</p><h3 id="字体加密">字体加密</h3><p>我们换一种思路，既然屏幕显示是根据 unicode 去查找对应的显示字形。</p><p>比如</p><pre><code class="hljs"><span class="hljs-comment">// 有一个字母A 的unicode 编码是0x41</span>
<span class="hljs-number">0</span><span class="hljs-function"><span class="hljs-title">x41</span> -&gt;</span> A
<span class="hljs-comment">// 那么我们修改成</span>
<span class="hljs-number">0</span><span class="hljs-function"><span class="hljs-title">x7b</span> -&gt;</span> A
</code></pre><p>我们提供我们加密后的字体文件，如果他复制粘贴到别的地方就会变成<code>&#123;</code></p><p>这样如果不用我们的字体文件，那么 shi yong fang 使用方就会一脸蒙蔽。</p><blockquote><p>行文仓促,如有纰漏，欢迎指出。</p></blockquote><script async>let codes = document.getElementsByClassName('hljs');
            Array.from(codes).forEach(code => {
                code.addEventListener('click', function copy(e) {
                    const textContent = e.currentTarget.textContent;
                    e.currentTarget.focus()
                    const node = e.currentTarget;
                    navigator.clipboard.writeText(textContent).then(()=>{
                        alert('复制成功')
                        node.blur()
                    });
                   
                })
            })</script><script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script><script>window.mermaid&&mermaid.initialize({startOnLoad:!0})</script></div></main><footer><p>Copyright © 2019-2022 suxin2017</p><p class="icp"><span><img src="/imgs/icp.png" width="17px" height="17px" alt="icp"> </span><a href="http://beian.miit.gov.cn" class="icp-link"><span>京ICP备2020041991号</span></a></p><p><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_site_pv">本站总访问量<span id="busuanzi_value_site_pv"></span>次</span></p></footer></div></body></html>