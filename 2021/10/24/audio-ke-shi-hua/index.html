<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><link rel="icon" sizes="any" type="image/svg+xml" href="/imgs/icon.svg"><link rel="stylesheet" href="/css/theme/color.variables.css"><link id="themeStyleVar" rel="stylesheet" href="/css/theme/default.variables.css"><script>const localStorageTheme = localStorage.getItem('theme');
        function loadTheme(){
            let themeLink = document.getElementById('themeStyleVar');
            if(localStorageTheme){
                themeLink.href = themeLink.href.replace(/\/css\/theme.*/,`/css/theme/${localStorageTheme}.variables.css`)
            }
        }
        if(localStorage){
            loadTheme()
            setTimeout(()=>{
                if(document.body){
                    document.body.className = localStorageTheme ? localStorageTheme : 'dark'
                }

            },2)
        }</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="/css/post.css"><title>苏鑫2017</title><meta name="description" content="用于记录感悟，前端技术，编程技巧，各种奇奇怪怪的新的体会"><meta name="viewport" content="width=device-width,initial-scale=1"><script async>console.log(`%c真巧，你打开了devtool`,"color:#b58900")
        console.log(`%c真巧，你看了我的文章`,"color:#859900")
        console.log('%c简单介绍，道法自然，做人要顺其自然，不要有太多欲望',"color:#268bd2")
        console.log('%c不要目的性太强,这就是我的主题想强调的',"color:#dc322f")</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-RFGTVED02M"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-RFGTVED02M")</script><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?ce46d6101f33ba04b74fbe8bbe509590";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script>const moduleMap = new Map();
            var define = (moduleName, module) => { moduleMap.set(moduleName, module) };
            var require = (moduleName) => moduleMap.get(moduleName);</script><meta name="generator" content="Hexo 5.4.2"><link rel="alternate" href="/atom.xml" title="苏鑫2017" type="application/atom+xml"></head><body><div class="body"><header class="header"><div class="header-icon-wrapper"><h2><a href="/">苏鑫2017</a></h2></div><div class="header-right"><nav class="header-menu-wrapper"><ul class="header-menu"><li class="header-menu-item"><a class="header-menu-item-link" href="/">首页</a></li><li class="header-menu-item"><a class="header-menu-item-link" href="/categories/weibo">微博</a></li><li class="header-menu-item"><a class="header-menu-item-link" href="/about">关于</a></li><li class="header-menu-item"><div id="switchThemeButton"><img src="/imgs/icon.svg" alt="switchThemeIcon" width="100%" height="100%"></div><style>#switchThemeButton{width:40px;height:26px;margin:0;border:0;background:0 0;outline:0;cursor:pointer;margin-top:6px}</style><script async>const btn = document.getElementById('switchThemeButton');
    let darkTheme = false;
    const themeStyleVarId = "themeStyleVar";
    if(localStorageTheme === 'dark'){
        darkTheme = true
    }else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
        // dark mode
        darkTheme = true;
    }
    function loadTheme() {
        let themeLink = document.getElementById(themeStyleVarId);
        if (!themeLink) {
            themeLink = document.createElement('link')
            themeLink.rel = "stylesheet"
            themeLink.id = "themeStyleVar"
        }
        darkTheme = !darkTheme;
        themeLink.href = themeLink.href.replace(/\/css\/theme.*/,`/css/theme/${darkTheme ? 'dark' : 'light'}.variables.css`)
        document.head.appendChild(themeLink)
        document.body.className = darkTheme?'dark':'light'
        localStorage.setItem('theme',darkTheme?'dark':'light');
    }

    btn.onclick = function() {
        loadTheme();
        codeTheme();
    }</script><script>function codeTheme(){
            const localStorageTheme = localStorage.getItem('theme');
            let codeThemeLink = document.getElementById("codeTheme");
            if(!codeThemeLink){
                codeThemeLink = document.createElement('link');
                codeThemeLink.rel = "stylesheet"
                codeThemeLink.id = "codeTheme"
                document.head.appendChild(codeThemeLink)
            }
            if(localStorageTheme){
                codeThemeLink.href = `//cdn.jsdelivr.net/npm/highlightjs@9.16.2/styles/solarized-${localStorageTheme}.css`
            }else{
                codeThemeLink.href = `//cdn.jsdelivr.net/npm/highlightjs@9.16.2/styles/solarized-${darkTheme ? 'dark': 'light'}.css`
            }
        }
        codeTheme()</script></li></ul></nav></div></header><main class="main"><div class="post"><h2>audio可视化</h2><div id="preview-0" class="preview"><div class="preview-box"><div id="draw-0">如果没有播放点击play可视化<div><audio id="audio" controls autoplay><source src="/imgs/demo.m4a" type="audio/mp4"></audio></div><div style="display:flex;flex-wrap:wrap;gap:20px"><div><div>波形</div><canvas id="canvas" width="200px" height="200px"></canvas></div><div><div>频率</div><canvas id="canvas1" width="200px" height="200px"></canvas></div></div><script type="module">const audio = document.getElementById('audio');
	const canvas = document.getElementById("canvas");
	const canvasCtx = canvas.getContext("2d");
	const canvas1 = document.getElementById("canvas1");
	const canvas1Ctx = canvas1.getContext("2d");
	let play = false;

	audio.addEventListener('play', function () {
		play = true;
		const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
		const source = audioCtx.createMediaElementSource(audio);

		const analyser = audioCtx.createAnalyser();
		const gainNode = audioCtx.createGain();
		gainNode.gain.value = 0.4;
		// source -> analyser
		source.connect(analyser);

		// analyser -> gainNode
		analyser.connect(gainNode);

		// gainNode -> 扬声器
		gainNode.connect(audioCtx.destination);


		const bufferLength = analyser.frequencyBinCount;
		const domainArray = new Uint8Array(bufferLength);
		const frequencyArray = new Uint8Array(bufferLength);
		analyser.getByteTimeDomainData(domainArray);
		let time = 0;
		function draw() {
			window.requestAnimationFrame(draw);

			if (play) {
				// analyser.getByteTimeDomainData(domainArray);
				// console.log('data', domainArray);
				// console.log('frequency', frequencyArray);
				// time++

				analyser.getByteTimeDomainData(domainArray);

				canvasCtx.fillStyle = "rgb(220, 220, 220)";
				canvasCtx.fillRect(0, 0, canvas.width, canvas.height);

				canvasCtx.lineWidth = 2;
				canvasCtx.strokeStyle = "rgb(0, 0, 0)";

				canvasCtx.beginPath();
				let skip = 2 ** 4;
				var sliceWidth = canvas.width * 1.0 / bufferLength * skip;
				var x = 0;

				for (let i = 0; i < bufferLength; i++) {

					var v = domainArray[i] / 128.0;
					var y = v * canvas.height / 2;

					if (i === 0) {
						canvasCtx.moveTo(x, y);
					} else {
						canvasCtx.lineTo(x, y);
					}

					x += sliceWidth;
				}

				canvasCtx.lineTo(canvas.width, canvas.height / 2);
				canvasCtx.stroke();

				// 频率
				analyser.getByteFrequencyData(frequencyArray);

				canvas1Ctx.fillStyle = 'rgb(220, 220, 220)';
				canvas1Ctx.fillRect(0, 0, canvas1.width, canvas1.height);
				var barWidth = (canvas1.width / bufferLength * skip) * 2.5;
				var barHeight;
				var x = 0;

				for (let i = 0; i < bufferLength; i++) {
					barHeight = frequencyArray[i];

					canvas1Ctx.fillStyle = 'rgb(' + (barHeight + 100) + '50,50,50)';
					canvas1Ctx.fillRect(x, canvas1.height - barHeight / 2, barWidth, barHeight / 2);
					x += barWidth + 1;
				}
			}

		}

		draw()
	})</script></div><div class="preview-box-util"><span id="expand-0" class="preview-box-util-code" style="background-image:url(/imgs/code.svg)"></span></div></div><div id="code-0" class="preview-code false"><pre><code class="hljs"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
	<span class="hljs-tag">&lt;<span class="hljs-name">audio</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;audio&quot;</span> <span class="hljs-attr">controls</span> <span class="hljs-attr">autoplay</span>&gt;</span>
		<span class="hljs-tag">&lt;<span class="hljs-name">source</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;/imgs/demo.m4a&quot;</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;audio/mp4&quot;</span> /&gt;</span>
	<span class="hljs-tag">&lt;/<span class="hljs-name">audio</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">&quot;display: flex;    flex-wrap: wrap; gap:20px&quot;</span>&gt;</span>
	<span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
		<span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>波形<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
		<span class="hljs-tag">&lt;<span class="hljs-name">canvas</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;canvas&quot;</span> <span class="hljs-attr">width</span>=<span class="hljs-string">&quot;200px&quot;</span> <span class="hljs-attr">height</span>=<span class="hljs-string">&#x27;200px&#x27;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">canvas</span>&gt;</span>
	<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
	<span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
		<span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>频率<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
		<span class="hljs-tag">&lt;<span class="hljs-name">canvas</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;canvas1&quot;</span> <span class="hljs-attr">width</span>=<span class="hljs-string">&quot;200px&quot;</span> <span class="hljs-attr">height</span>=<span class="hljs-string">&#x27;200px&#x27;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">canvas</span>&gt;</span>
	<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;module&quot;</span>&gt;</span><span class="language-javascript">
	<span class="hljs-keyword">const</span> audio = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&#x27;audio&#x27;</span>);
	<span class="hljs-keyword">const</span> canvas = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&quot;canvas&quot;</span>);
	<span class="hljs-keyword">const</span> canvasCtx = canvas.<span class="hljs-title function_">getContext</span>(<span class="hljs-string">&quot;2d&quot;</span>);
	<span class="hljs-keyword">const</span> canvas1 = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&quot;canvas1&quot;</span>);
	<span class="hljs-keyword">const</span> canvas1Ctx = canvas1.<span class="hljs-title function_">getContext</span>(<span class="hljs-string">&quot;2d&quot;</span>);
	<span class="hljs-keyword">let</span> play = <span class="hljs-literal">false</span>;

	audio.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;play&#x27;</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;
		play = <span class="hljs-literal">true</span>;
		<span class="hljs-keyword">const</span> audioCtx = <span class="hljs-keyword">new</span> (<span class="hljs-variable language_">window</span>.<span class="hljs-property">AudioContext</span> || <span class="hljs-variable language_">window</span>.<span class="hljs-property">webkitAudioContext</span>)();
		<span class="hljs-keyword">const</span> source = audioCtx.<span class="hljs-title function_">createMediaElementSource</span>(audio);

		<span class="hljs-keyword">const</span> analyser = audioCtx.<span class="hljs-title function_">createAnalyser</span>();
		<span class="hljs-keyword">const</span> gainNode = audioCtx.<span class="hljs-title function_">createGain</span>();
		gainNode.<span class="hljs-property">gain</span>.<span class="hljs-property">value</span> = <span class="hljs-number">0.4</span>;
		<span class="hljs-comment">// source -&gt; analyser</span>
		source.<span class="hljs-title function_">connect</span>(analyser);

		<span class="hljs-comment">// analyser -&gt; gainNode</span>
		analyser.<span class="hljs-title function_">connect</span>(gainNode);

		<span class="hljs-comment">// gainNode -&gt; 扬声器</span>
		gainNode.<span class="hljs-title function_">connect</span>(audioCtx.<span class="hljs-property">destination</span>);


		<span class="hljs-keyword">const</span> bufferLength = analyser.<span class="hljs-property">frequencyBinCount</span>;
		<span class="hljs-keyword">const</span> domainArray = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(bufferLength);
		<span class="hljs-keyword">const</span> frequencyArray = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>(bufferLength);
		analyser.<span class="hljs-title function_">getByteTimeDomainData</span>(domainArray);
		<span class="hljs-keyword">let</span> time = <span class="hljs-number">0</span>;
		<span class="hljs-keyword">function</span> <span class="hljs-title function_">draw</span>(<span class="hljs-params"></span>) &#123;
			<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">requestAnimationFrame</span>(draw);

			<span class="hljs-keyword">if</span> (play) &#123;
				<span class="hljs-comment">// analyser.getByteTimeDomainData(domainArray);</span>
				<span class="hljs-comment">// console.log(&#x27;data&#x27;, domainArray);</span>
				<span class="hljs-comment">// console.log(&#x27;frequency&#x27;, frequencyArray);</span>
				<span class="hljs-comment">// time++</span>

				analyser.<span class="hljs-title function_">getByteTimeDomainData</span>(domainArray);

				canvasCtx.<span class="hljs-property">fillStyle</span> = <span class="hljs-string">&quot;rgb(220, 220, 220)&quot;</span>;
				canvasCtx.<span class="hljs-title function_">fillRect</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, canvas.<span class="hljs-property">width</span>, canvas.<span class="hljs-property">height</span>);

				canvasCtx.<span class="hljs-property">lineWidth</span> = <span class="hljs-number">2</span>;
				canvasCtx.<span class="hljs-property">strokeStyle</span> = <span class="hljs-string">&quot;rgb(0, 0, 0)&quot;</span>;

				canvasCtx.<span class="hljs-title function_">beginPath</span>();
				<span class="hljs-keyword">let</span> skip = <span class="hljs-number">2</span> ** <span class="hljs-number">4</span>;
				<span class="hljs-keyword">var</span> sliceWidth = canvas.<span class="hljs-property">width</span> * <span class="hljs-number">1.0</span> / bufferLength * skip;
				<span class="hljs-keyword">var</span> x = <span class="hljs-number">0</span>;

				<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; bufferLength; i++) &#123;

					<span class="hljs-keyword">var</span> v = domainArray[i] / <span class="hljs-number">128.0</span>;
					<span class="hljs-keyword">var</span> y = v * canvas.<span class="hljs-property">height</span> / <span class="hljs-number">2</span>;

					<span class="hljs-keyword">if</span> (i === <span class="hljs-number">0</span>) &#123;
						canvasCtx.<span class="hljs-title function_">moveTo</span>(x, y);
					&#125; <span class="hljs-keyword">else</span> &#123;
						canvasCtx.<span class="hljs-title function_">lineTo</span>(x, y);
					&#125;

					x += sliceWidth;
				&#125;

				canvasCtx.<span class="hljs-title function_">lineTo</span>(canvas.<span class="hljs-property">width</span>, canvas.<span class="hljs-property">height</span> / <span class="hljs-number">2</span>);
				canvasCtx.<span class="hljs-title function_">stroke</span>();

				<span class="hljs-comment">// 频率</span>
				analyser.<span class="hljs-title function_">getByteFrequencyData</span>(frequencyArray);

				canvas1Ctx.<span class="hljs-property">fillStyle</span> = <span class="hljs-string">&#x27;rgb(220, 220, 220)&#x27;</span>;
				canvas1Ctx.<span class="hljs-title function_">fillRect</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, canvas1.<span class="hljs-property">width</span>, canvas1.<span class="hljs-property">height</span>);
				<span class="hljs-keyword">var</span> barWidth = (canvas1.<span class="hljs-property">width</span> / bufferLength * skip) * <span class="hljs-number">2.5</span>;
				<span class="hljs-keyword">var</span> barHeight;
				<span class="hljs-keyword">var</span> x = <span class="hljs-number">0</span>;

				<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; bufferLength; i++) &#123;
					barHeight = frequencyArray[i];

					canvas1Ctx.<span class="hljs-property">fillStyle</span> = <span class="hljs-string">&#x27;rgb(&#x27;</span> + (barHeight + <span class="hljs-number">100</span>) + <span class="hljs-string">&#x27;50,50,50)&#x27;</span>;
					canvas1Ctx.<span class="hljs-title function_">fillRect</span>(x, canvas1.<span class="hljs-property">height</span> - barHeight / <span class="hljs-number">2</span>, barWidth, barHeight / <span class="hljs-number">2</span>);
					x += barWidth + <span class="hljs-number">1</span>;
				&#125;
			&#125;

		&#125;

		<span class="hljs-title function_">draw</span>()
	&#125;)
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre></div><script>const expandCode_0 = document.getElementById('expand-0');
    const bindCode_0 = document.getElementById('code-0');
    let flag_0 = true;
    expandCode_0.onclick = function (){
        if(flag_0){
            bindCode_0.classList.add('preview-code-active')
        }else{
            bindCode_0.classList.remove('preview-code-active') 
        }
        flag_0 = !flag_0
    }</script></div><script async>let codes = document.getElementsByClassName('hljs');
            Array.from(codes).forEach(code => {
                code.addEventListener('click', function copy(e) {
                    const textContent = e.currentTarget.textContent;
                    e.currentTarget.focus()
                    const node = e.currentTarget;
                    navigator.clipboard.writeText(textContent).then(()=>{
                        alert('复制成功')
                        node.blur()
                    });
                   
                })
            })</script><script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script><script>window.mermaid&&mermaid.initialize({startOnLoad:!0})</script></div></main><footer><p>Copyright © 2019-2022 suxin2017</p><p class="icp"><span><img src="/imgs/icp.png" width="17px" height="17px" alt="icp"> </span><a href="http://beian.miit.gov.cn" class="icp-link"><span>京ICP备2020041991号</span></a></p><p><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_site_pv">本站总访问量<span id="busuanzi_value_site_pv"></span>次</span></p></footer></div></body></html>